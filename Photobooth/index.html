<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snaply</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700;900&family=Syne:wght@800&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --vintage-red: #F96E5B;
            --vintage-cream: #FFE2AF;
            --vintage-teal: #79C9C5;
            --vintage-blue: #3F9AAE;
            --ink: #1A1A1A;
        }

        body {
            font-family: 'Public Sans', sans-serif;
            background-color: var(--vintage-cream);
            color: var(--ink);
            overscroll-behavior: none; /* Prevent bounce */
        }

        h1, h2, h3, .heading-font {
            font-family: 'Syne', sans-serif;
        }

        .handwritten {
            font-family: 'Caveat', cursive;
        }

        /* Neo-Brutalist Utilities */
        .brutal-border {
            border: 3px solid var(--ink);
        }

        .brutal-shadow {
            box-shadow: 4px 4px 0px var(--ink);
        }

        .brutal-btn {
            border: 3px solid var(--ink);
            box-shadow: 4px 4px 0px var(--ink);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .brutal-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--ink);
        }

        .brutal-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px var(--ink);
        }

        .camera-mirror {
            transform: scaleX(-1);
        }

        /* Camera Flash */
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; background: white; }
            100% { opacity: 0; }
        }
        .flash-overlay { animation: flash 0.2s ease-out; }

        /* --- New Sticker System Styles --- */
        .sticker-wrapper {
            position: absolute;
            user-select: none;
            touch-action: none;
            cursor: grab;
            transform-origin: center center;
            box-sizing: border-box;
        }
        
        .sticker-wrapper img {
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.1));
        }

        .sticker-wrapper.selected {
            outline: 2px dashed var(--ink);
            z-index: 100 !important;
        }

        .control-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 2px solid var(--ink);
            display: none;
            z-index: 101;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
        }

        .sticker-wrapper.selected .control-handle {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rotate-handle {
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--vintage-red);
            border-radius: 50%;
            cursor: grab;
        }
        
        .rotate-line {
            position: absolute;
            top: -40px;
            left: 50%;
            width: 2px;
            height: 40px;
            background-color: var(--ink);
            transform: translateX(-50%);
            display: none;
        }
        .sticker-wrapper.selected .rotate-line { display: block; }

        .resize-handle {
            bottom: -12px;
            right: -12px;
            background-color: var(--vintage-blue);
            cursor: nwse-resize;
        }
        
        .handle-icon {
            font-size: 12px;
            font-weight: bold;
            color: white;
            pointer-events: none;
        }

        /* --- Sticker Tray Styles --- */
        .sticker-tray {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            max-height: 160px;
            overflow-y: auto;
            background: #fff;
            padding: 12px;
            border: 3px solid var(--ink);
        }

        .tray-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.1s;
        }

        .tray-item:hover {
            background-color: #f1f5f9;
            transform: scale(1.1);
        }
        
        .tray-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden">

    <!-- BOX 1: TOP NAVIGATION (Full Width) -->
    <header class="w-full relative py-6 px-4 mb-4">
        <!-- Navigation Container -->
        <nav class="w-full max-w-7xl mx-auto flex items-center justify-center relative h-14">
            
            <!-- Home Button: Absolute Left -->
            <a href="landing.html" class="absolute left-0 top-1/2 -translate-y-1/2 flex items-center gap-2 font-bold uppercase text-xs bg-white text-[#1A1A1A] no-underline z-20 px-4 py-2 brutal-border brutal-shadow">
                Home
            </a>
            
            <!-- Title: Centered -->
            <h1 class="text-3xl sm:text-5xl font-black tracking-tighter uppercase text-center z-10">
                Snap<span class="text-[#F96E5B]">ly</span>
            </h1>

        </nav>

        <!-- Subtitle Badge (Centered below title) -->
        <div class="flex justify-center mt-2">
            <div class="bg-[#79C9C5] text-black text-xs font-bold uppercase tracking-widest px-3 py-1 brutal-border brutal-shadow transform -rotate-2">
                Simply snap now!
            </div>
        </div>
    </header>


    <!-- BOX 2: MAIN CONTENT (Centered & Restricted Width) -->
    <div id="app" class="w-full max-w-md mx-auto px-4 flex-grow flex flex-col items-center">
        
        <!-- Mode Selector: Grid Layout for 4 buttons -->
        <div id="controls-section" class="grid grid-cols-2 gap-3 mb-8 w-full">
            <button onclick="setMode('single')" id="btn-single" class="brutal-btn bg-[#1A1A1A] text-white px-4 py-3 font-bold text-sm uppercase flex items-center justify-center gap-2">
                <span class="text-lg">â—¼</span> Single
            </button>
            <button onclick="setMode('grid')" id="btn-grid" class="brutal-btn bg-white text-[#1A1A1A] px-4 py-3 font-bold text-sm uppercase flex items-center justify-center gap-2 hover:bg-slate-50">
                <span class="text-lg">âŠž</span> 2x2 Grid
            </button>
            <button onclick="setMode('strip')" id="btn-strip" class="brutal-btn bg-white text-[#1A1A1A] px-4 py-3 font-bold text-sm uppercase flex items-center justify-center gap-2 hover:bg-slate-50">
                <span class="text-lg rotate-90">||||</span> 1x4 Strip
            </button>
            <button onclick="setMode('grid2x4')" id="btn-grid2x4" class="brutal-btn bg-white text-[#1A1A1A] px-4 py-3 font-bold text-sm uppercase flex items-center justify-center gap-2 hover:bg-slate-50">
                <span class="text-lg">â–¦</span> 2x4 Grid
            </button>
        </div>

        <!-- Main Workspace -->
        <main class="relative w-full">
            
            <!-- Viewfinder Section -->
            <div id="viewfinder-section" class="relative overflow-hidden bg-black aspect-[3/4] brutal-border brutal-shadow mb-6">
                <video id="video" autoplay playsinline class="w-full h-full object-cover camera-mirror"></video>
                
                <!-- Countdown Overlay -->
                <div id="countdown-overlay" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm z-20">
                    <span id="countdown-text" class="text-[#FFE2AF] text-[10rem] heading-font font-black leading-none drop-shadow-[4px_4px_0_#F96E5B]">3</span>
                    <span id="sequence-text" class="text-white font-bold text-xl uppercase tracking-widest mt-4 bg-[#F96E5B] border-2 border-black px-4 py-1 hidden shadow-[4px_4px_0_#000]">Photo 1/4</span>
                </div>

                <!-- Flash Effect -->
                <div id="flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none z-30"></div>

                <!-- Capture Button -->
                <div class="absolute bottom-8 left-0 right-0 flex justify-center z-10">
                    <button id="snap-btn" class="group relative transition-transform active:scale-95">
                        <div class="w-20 h-20 bg-white rounded-full border-4 border-[#1A1A1A] flex items-center justify-center shadow-[4px_4px_0_#1A1A1A]">
                            <div class="w-16 h-16 rounded-full bg-[#F96E5B] border-4 border-[#1A1A1A] group-hover:bg-[#ff8676]"></div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Preview/Editing Section -->
            <div id="preview-section" class="hidden animate-in fade-in zoom-in duration-300">
                
                <!-- The Canvas Container -->
                <div class="bg-white p-4 pb-8 brutal-border brutal-shadow mb-8 relative">
                    <!-- Paper texture/container -->
                    <div id="canvas-container" class="relative overflow-hidden bg-white mx-auto border-2 border-slate-100 touch-none">
                        <canvas id="final-canvas" class="w-full block"></canvas>
                        
                        <!-- Sticker Layer -->
                        <div id="sticker-layer" class="absolute inset-0 z-10 overflow-hidden">
                            <!-- Stickers injected here via JS -->
                        </div>

                        <!-- Caption Input -->
                        <div class="mt-4 px-2 relative z-20 absolute bottom-4 left-0 right-0">
                            <input type="text" id="caption-input" maxlength="30" placeholder="Sign your photo..." class="w-full text-center text-3xl handwritten border-none focus:ring-0 focus:outline-none bg-transparent placeholder-slate-300 text-[#1A1A1A]">
                        </div>
                    </div>
                </div>

                <!-- Decoration Tools -->
                <div class="bg-[#3F9AAE] p-6 brutal-border brutal-shadow mb-6">
                    <h3 class="text-white text-xl font-black uppercase mb-4 tracking-widest drop-shadow-md">Studio Tools</h3>
                    
                    <div class="space-y-6">
                        <!-- Color Picker -->
                        <div class="bg-white p-4 brutal-border">
                            <p class="text-xs font-bold text-black uppercase mb-3 tracking-wider">Background Color</p>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="setBg('#ffffff')" class="w-8 h-8 rounded-full border-2 border-black bg-white shadow-[2px_2px_0_#000] hover:-translate-y-1 hover:shadow-[4px_4px_0_#000] active:translate-y-0 active:shadow-[2px_2px_0_#000] transition-all"></button>
                                <button onclick="setBg('#1e293b')" class="w-8 h-8 rounded-full border-2 border-black bg-slate-800 shadow-[2px_2px_0_#000] hover:-translate-y-1 hover:shadow-[4px_4px_0_#000] active:translate-y-0 active:shadow-[2px_2px_0_#000] transition-all"></button>
                                <button onclick="setBg('#F96E5B')" class="w-8 h-8 rounded-full border-2 border-black bg-[#F96E5B] shadow-[2px_2px_0_#000] hover:-translate-y-1 hover:shadow-[4px_4px_0_#000] active:translate-y-0 active:shadow-[2px_2px_0_#000] transition-all"></button>
                                <button onclick="setBg('#FFE2AF')" class="w-8 h-8 rounded-full border-2 border-black bg-[#FFE2AF] shadow-[2px_2px_0_#000] hover:-translate-y-1 hover:shadow-[4px_4px_0_#000] active:translate-y-0 active:shadow-[2px_2px_0_#000] transition-all"></button>
                                <button onclick="setBg('#79C9C5')" class="w-8 h-8 rounded-full border-2 border-black bg-[#79C9C5] shadow-[2px_2px_0_#000] hover:-translate-y-1 hover:shadow-[4px_4px_0_#000] active:translate-y-0 active:shadow-[2px_2px_0_#000] transition-all"></button>
                            </div>
                        </div>

                        <!-- Sticker Tray (New Feature) -->
                        <div class="bg-white p-4 brutal-border">
                            <p class="text-xs font-bold text-black uppercase mb-3 tracking-wider">Sticker Collection</p>
                            <div id="sticker-tray" class="sticker-tray">
                                <!-- Stickers will be loaded here by JS -->
                            </div>
                        </div>

                        <!-- Manual Upload -->
                        <div class="bg-white p-4 brutal-border">
                            <p class="text-xs font-bold text-black uppercase mb-3 tracking-wider">Or Upload Your Own</p>
                            <label class="flex flex-col items-center justify-center w-full h-14 border-2 border-dashed border-black bg-slate-50 cursor-pointer hover:bg-[#FFE2AF] transition-colors">
                                <span class="text-sm font-bold uppercase flex items-center gap-2">
                                    <span class="text-xl">ðŸ“‚</span> Select File
                                </span>
                                <input type="file" id="sticker-upload" accept="image/*" class="hidden">
                            </label>
                            <p class="text-[10px] font-bold uppercase text-right mt-2 opacity-50">Tap to select â€¢ Drag corner to resize</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="retake-btn" class="flex-1 brutal-btn bg-white text-black font-black uppercase py-4 hover:bg-slate-100 text-lg">
                        Start Over
                    </button>
                    <button id="download-btn" class="flex-[2] brutal-btn bg-[#F96E5B] text-white font-black uppercase py-4 hover:bg-[#ff8676] text-lg flex justify-center items-center gap-2">
                        <span>ðŸ’¾</span> Download Strip
                    </button>
                </div>
            </div>

        </main>
        
        <footer class="mt-12 mb-8 text-center text-black/40 text-xs font-bold uppercase tracking-widest">
            Snaply â€¢ Images processed locally
        </footer>
    </div>

    <!-- Logic Script -->
    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const finalCanvas = document.getElementById('final-canvas');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownText = document.getElementById('countdown-text');
        const sequenceText = document.getElementById('sequence-text');
        const flashEl = document.getElementById('flash');
        const snapBtn = document.getElementById('snap-btn');
        const downloadBtn = document.getElementById('download-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const viewfinderSection = document.getElementById('viewfinder-section');
        const previewSection = document.getElementById('preview-section');
        const canvasContainer = document.getElementById('canvas-container');
        const controlsSection = document.getElementById('controls-section');
        const captionInput = document.getElementById('caption-input');
        // New Buttons
        const btnSingle = document.getElementById('btn-single');
        const btnGrid = document.getElementById('btn-grid');
        const btnStrip = document.getElementById('btn-strip');
        const btnGrid2x4 = document.getElementById('btn-grid2x4');
        
        const stickerUpload = document.getElementById('sticker-upload');
        const stickerLayer = document.getElementById('sticker-layer');
        const stickerTray = document.getElementById('sticker-tray');

        // State
        let currentMode = 'single';
        let capturedImages = [];
        let stream;
        let currentBgColor = '#ffffff';
        let activeSticker = null; // Track selected sticker

        // --- PREMADE STICKER LIBRARY ---
        const CUSTOM_STICKERS = ['./Stickers/flower.png'];
        const TWEMOJI_CODES = ["2764", "2728", "2b50", "1f380", "1f451", "1f60e", "270c", "1f525", "1f48b", "1f47b", "1f338", "1f308", "1f498", "1f4a5", "1f389"];

        function initStickerLibrary() {
            stickerTray.innerHTML = ""; 
            CUSTOM_STICKERS.forEach(url => addTrayItem(url));
            TWEMOJI_CODES.forEach(code => {
                const url = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/${code}.png`;
                addTrayItem(url);
            });
        }

        function addTrayItem(url) {
            const div = document.createElement('div');
            div.className = 'tray-item';
            div.innerHTML = `<img src="${url}" alt="sticker" loading="lazy">`;
            div.onclick = () => createSticker(url);
            stickerTray.appendChild(div);
        }

        // Initialize Camera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 1280 } }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Camera access required. Please check permissions.");
            }
        }

        // Mode Switching
        window.setMode = (mode) => {
            currentMode = mode;
            const activeClass = "brutal-btn bg-[#1A1A1A] text-white px-4 py-3 font-bold text-sm uppercase flex items-center justify-center gap-2";
            const inactiveClass = "brutal-btn bg-white text-[#1A1A1A] px-4 py-3 font-bold text-sm uppercase flex items-center justify-center gap-2 hover:bg-slate-50";

            // Reset all
            btnSingle.className = inactiveClass;
            btnGrid.className = inactiveClass;
            btnStrip.className = inactiveClass;
            btnGrid2x4.className = inactiveClass;

            // Set active
            if (mode === 'single') btnSingle.className = activeClass;
            else if (mode === 'grid') btnGrid.className = activeClass;
            else if (mode === 'strip') btnStrip.className = activeClass;
            else if (mode === 'grid2x4') btnGrid2x4.className = activeClass;
        };

        snapBtn.addEventListener('click', () => {
            if (currentMode === 'single') {
                startCountdown(1, () => captureSingle());
            } else if (currentMode === 'grid') {
                startGridSequence(4);
            } else if (currentMode === 'strip') {
                startGridSequence(4);
            } else if (currentMode === 'grid2x4') {
                startGridSequence(8);
            }
        });

        function startCountdown(seconds, callback, sequenceNum = null, total = null) {
            let count = seconds;
            countdownOverlay.classList.remove('hidden');
            countdownText.innerText = count;
            sequenceText.classList.toggle('hidden', !sequenceNum);
            if (sequenceNum) sequenceText.innerText = `PHOTO ${sequenceNum}/${total || 1}`;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownText.innerText = count;
                } else {
                    clearInterval(interval);
                    triggerFlash();
                    callback();
                }
            }, 1000);
        }

        function triggerFlash() {
            flashEl.classList.add('flash-overlay');
            setTimeout(() => flashEl.classList.remove('flash-overlay'), 500);
        }

        async function startGridSequence(totalCount) {
            capturedImages = [];
            controlsSection.classList.add('pointer-events-none', 'opacity-50');
            
            for (let i = 1; i <= totalCount; i++) {
                await new Promise(resolve => {
                    startCountdown(3, () => {
                        const img = captureFrameToImage();
                        capturedImages.push(img);
                        resolve();
                    }, i, totalCount);
                });
                if(i < totalCount) {
                    countdownText.innerText = "READY"; 
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            finishCapture();
        }

        function captureSingle() {
            capturedImages = [captureFrameToImage()];
            finishCapture();
        }

        function captureFrameToImage() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.translate(tempCanvas.width, 0);
            ctx.scale(-1, 1);
            ctx.filter = 'contrast(1.1) brightness(1.05)';
            ctx.drawImage(video, 0, 0);
            const img = new Image();
            img.src = tempCanvas.toDataURL('image/jpeg');
            return img;
        }

        function finishCapture() {
            countdownOverlay.classList.add('hidden');
            controlsSection.classList.remove('pointer-events-none', 'opacity-50');
            viewfinderSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
            controlsSection.classList.add('hidden');
            setTimeout(drawComposite, 100);
        }

        // --- STICKER LOGIC (Existing) ---
        canvasContainer.addEventListener('mousedown', (e) => {
            if (e.target === canvasContainer || e.target === stickerLayer) deselectAll();
        });
        canvasContainer.addEventListener('touchstart', (e) => {
            if (e.target === canvasContainer || e.target === stickerLayer) deselectAll();
        });

        function deselectAll() {
            document.querySelectorAll('.sticker-wrapper').forEach(el => el.classList.remove('selected'));
            activeSticker = null;
        }

        stickerUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => { createSticker(event.target.result); stickerUpload.value = ''; };
            reader.readAsDataURL(file);
        });

        function createSticker(src) {
            const wrapper = document.createElement('div');
            wrapper.className = 'sticker-wrapper selected';
            wrapper.style.left = '50%';
            wrapper.style.top = '50%';
            wrapper.style.width = '100px';
            wrapper.style.height = '100px';
            wrapper.style.transform = 'translate(-50%, -50%) rotate(0deg)';
            
            const img = document.createElement('img');
            img.crossOrigin = "anonymous"; 
            img.src = src;
            wrapper.appendChild(img);

            const rotateLine = document.createElement('div');
            rotateLine.className = 'rotate-line';
            wrapper.appendChild(rotateLine);
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'control-handle rotate-handle';
            rotateHandle.innerHTML = '<span class="handle-icon">âŸ³</span>';
            wrapper.appendChild(rotateHandle);
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'control-handle resize-handle';
            resizeHandle.innerHTML = '<span class="handle-icon">â¤¡</span>';
            wrapper.appendChild(resizeHandle);

            makeInteractive(wrapper, rotateHandle, resizeHandle);
            wrapper.addEventListener('dblclick', () => wrapper.remove());
            deselectAll();
            activeSticker = wrapper;
            stickerLayer.appendChild(wrapper);
        }

        function makeInteractive(wrapper, rotateHandle, resizeHandle) {
            let startX, startY, startLeft, startTop, startWidth, startHeight, startAngle = 0, currentRotation = 0;
            let isDragging = false, isResizing = false, isRotating = false;

            function updateTransform(rotation) {
                currentRotation = rotation;
                wrapper.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            }

            function onDown(e, type) {
                e.preventDefault(); e.stopPropagation();
                deselectAll(); wrapper.classList.add('selected'); activeSticker = wrapper;
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                startX = clientX; startY = clientY;

                if(wrapper.style.left.includes('%')) {
                     startLeft = wrapper.offsetLeft + (wrapper.offsetWidth/2);
                     startTop = wrapper.offsetTop + (wrapper.offsetHeight/2);
                     wrapper.style.left = startLeft + 'px'; wrapper.style.top = startTop + 'px';
                } else {
                    startLeft = parseFloat(wrapper.style.left); startTop = parseFloat(wrapper.style.top);
                }
                startWidth = wrapper.offsetWidth; startHeight = wrapper.offsetHeight;
                
                const rect = wrapper.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
                startAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
                if(!currentRotation) currentRotation = 0; 

                if (type === 'resize') isResizing = true;
                else if (type === 'rotate') isRotating = true;
                else isDragging = true;

                document.addEventListener(e.type.includes('mouse') ? 'mousemove' : 'touchmove', onMove, {passive: false});
                document.addEventListener(e.type.includes('mouse') ? 'mouseup' : 'touchend', onUp);
            }

            function onMove(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;

                if (isDragging) {
                    wrapper.style.left = `${startLeft + (clientX - startX)}px`;
                    wrapper.style.top = `${startTop + (clientY - startY)}px`;
                } else if (isResizing) {
                    const newW = Math.max(30, startWidth + (clientX - startX)); 
                    wrapper.style.width = `${newW}px`; wrapper.style.height = `${newW}px`;
                } else if (isRotating) {
                    const rect = wrapper.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
                    const angle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
                    updateTransform(currentRotation + (angle - startAngle));
                }
            }

            function onUp() {
                isDragging = false; isResizing = false; isRotating = false;
                document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp);
                document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onUp);
            }

            wrapper.addEventListener('mousedown', (e) => onDown(e, 'drag'));
            wrapper.addEventListener('touchstart', (e) => onDown(e, 'drag'));
            resizeHandle.addEventListener('mousedown', (e) => onDown(e, 'resize'));
            resizeHandle.addEventListener('touchstart', (e) => onDown(e, 'resize'));
            rotateHandle.addEventListener('mousedown', (e) => onDown(e, 'rotate'));
            rotateHandle.addEventListener('touchstart', (e) => onDown(e, 'rotate'));
        }

        // --- UPDATED CANVAS DRAWING ---
        function drawComposite() {
            const ctx = finalCanvas.getContext('2d');
            let width, height, padding, gap;

            // Define Layouts
            if (currentMode === 'single') {
                width = 1000; height = 1100; padding = 40;
            } else if (currentMode === 'grid') { // 2x2
                width = 1000; height = 1110; padding = 40; gap = 20;
            } else if (currentMode === 'strip') { // 1x4 Strip
                width = 600; height = 2400; padding = 30; gap = 20;
            } else if (currentMode === 'grid2x4') { // 2x4 Big Grid
                width = 1200; height = 2400; padding = 40; gap = 30;
            }

            finalCanvas.width = width;
            finalCanvas.height = height;
            ctx.fillStyle = currentBgColor;
            ctx.fillRect(0, 0, width, height);

            if (currentMode === 'single') {
                const img = capturedImages[0];
                const photoW = width - (padding * 2);
                drawPhoto(ctx, img, padding, padding, photoW, photoW);
            } 
            else if (currentMode === 'grid') { // 2x2
                const photoW = (width - (padding * 2) - gap) / 2;
                const positions = [
                    { x: padding, y: padding }, { x: padding + photoW + gap, y: padding },
                    { x: padding, y: padding + photoW + gap }, { x: padding + photoW + gap, y: padding + photoW + gap }
                ];
                capturedImages.forEach((img, i) => drawPhoto(ctx, img, positions[i].x, positions[i].y, photoW, photoW));
            }
            else if (currentMode === 'strip') { // 1x4
                const photoW = width - (padding * 2);
                // 4 photos vertically
                for(let i=0; i<4; i++) {
                    const y = padding + (i * (photoW + gap));
                    if(capturedImages[i]) drawPhoto(ctx, capturedImages[i], padding, y, photoW, photoW);
                }
            }
            else if (currentMode === 'grid2x4') { // 2x4
                const photoW = (width - (padding * 2) - gap) / 2;
                for(let i=0; i<8; i++) {
                    const row = Math.floor(i / 2);
                    const col = i % 2;
                    const x = padding + (col * (photoW + gap));
                    const y = padding + (row * (photoW + gap));
                    if(capturedImages[i]) drawPhoto(ctx, capturedImages[i], x, y, photoW, photoW);
                }
            }
        }

        // Helper to center-crop standard aspect ratio into square
        function drawPhoto(ctx, img, x, y, w, h) {
            const minDim = Math.min(img.width, img.height);
            const sx = (img.width - minDim) / 2;
            const sy = (img.height - minDim) / 2;
            ctx.drawImage(img, sx, sy, minDim, minDim, x, y, w, h);
            ctx.strokeStyle = "#1A1A1A";
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);
        }

        window.setBg = (color) => {
            currentBgColor = color;
            canvasContainer.style.backgroundColor = color;
            drawComposite();
        };

        downloadBtn.addEventListener('click', () => {
            deselectAll();
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = finalCanvas.width;
            exportCanvas.height = finalCanvas.height;
            const ctx = exportCanvas.getContext('2d');

            ctx.drawImage(finalCanvas, 0, 0);

            const containerRect = canvasContainer.getBoundingClientRect();
            const scaleX = finalCanvas.width / containerRect.width;
            const scaleY = finalCanvas.height / containerRect.height;

            const wrappers = stickerLayer.querySelectorAll('.sticker-wrapper');
            wrappers.forEach(wrapper => {
                const img = wrapper.querySelector('img');
                const xPos = parseFloat(wrapper.style.left);
                const yPos = parseFloat(wrapper.style.top);
                const w = parseFloat(wrapper.style.width);
                const h = parseFloat(wrapper.style.height);

                let rotation = 0;
                const transform = wrapper.style.transform;
                if(transform && transform.includes('rotate')) {
                    const match = transform.match(/rotate\(([-\d.]+)deg\)/);
                    if(match) rotation = parseFloat(match[1]);
                }

                const cx = xPos * scaleX;
                const cy = yPos * scaleY;
                const cw = w * scaleX;
                const ch = h * scaleY;
                const rads = rotation * (Math.PI / 180);

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(rads);
                try { ctx.drawImage(img, -cw/2, -ch/2, cw, ch); } catch(e) {}
                ctx.restore();
            });

            // Text Logic - Adjusted position for strip mode
            const text = captionInput.value;
            if (text) {
                ctx.fillStyle = "#1e293b";
                ctx.font = "bold 80px 'Caveat'";
                ctx.textAlign = "center";
                // Place text near bottom edge based on new heights
                const textY = exportCanvas.height - 80; 
                ctx.fillText(text, exportCanvas.width / 2, textY);
            }

            const link = document.createElement('a');
            link.download = `quadsnap-${Date.now()}.jpg`;
            link.href = exportCanvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });

        retakeBtn.addEventListener('click', () => {
            previewSection.classList.add('hidden');
            viewfinderSection.classList.remove('hidden');
            controlsSection.classList.remove('hidden');
            captionInput.value = "";
            setBg('#ffffff');
            stickerLayer.innerHTML = '';
            initCamera();
        });

        window.onload = () => { initCamera(); initStickerLibrary(); };

    </script>
</body>
</html>